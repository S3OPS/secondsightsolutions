<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AutoFlight - DJI Mini 4K Flight Planner | Second Sight Solutions</title>
    <meta name="description" content="Plan, configure, and export automated flight paths for DJI Mini 4K drone in KMZ format">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 30px 20px;
            background: rgba(255, 0, 51, 0.1);
            border-bottom: 2px solid #ff0033;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5em;
            color: #ff0033;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 0, 51, 0.5);
        }
        
        .subtitle {
            font-size: 1.1em;
            color: #cccccc;
        }
        
        .app-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .controls-panel {
            background: rgba(26, 26, 46, 0.8);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            height: fit-content;
        }
        
        .section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            font-size: 1.2em;
            color: #ff0033;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #cccccc;
            font-size: 0.9em;
        }
        
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #444;
            border-radius: 5px;
            color: #ffffff;
            font-size: 0.95em;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #ff0033;
        }
        
        .map-container {
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        #canvas-map {
            width: 100%;
            height: 600px;
            cursor: crosshair;
            background: #0a0a0a;
            border-radius: 10px;
        }
        
        .button {
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, #ff0033 0%, #cc0029 100%);
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .button:hover {
            background: linear-gradient(135deg, #cc0029 0%, #990020 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 0, 51, 0.4);
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .button-secondary {
            background: linear-gradient(135deg, #333 0%, #222 100%);
        }
        
        .button-secondary:hover {
            background: linear-gradient(135deg, #444 0%, #333 100%);
        }
        
        .waypoint-list {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
        }
        
        .waypoint-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 5px;
            border-radius: 3px;
            font-size: 0.85em;
        }
        
        .waypoint-item:hover {
            background: rgba(255, 0, 51, 0.1);
        }
        
        .waypoint-coords {
            flex: 1;
        }
        
        .waypoint-delete {
            background: #cc0029;
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .waypoint-delete:hover {
            background: #990020;
        }
        
        .info-box {
            background: rgba(255, 0, 51, 0.1);
            border: 1px solid #ff0033;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .info-label {
            color: #cccccc;
        }
        
        .info-value {
            color: #ff0033;
            font-weight: bold;
        }
        
        .instructions {
            background: rgba(26, 26, 46, 0.8);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .instructions h3 {
            color: #ff0033;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            margin-left: 20px;
            line-height: 1.8;
        }
        
        .instructions li {
            margin-bottom: 10px;
            color: #cccccc;
        }
        
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        
        .map-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.85em;
            color: #ccc;
            z-index: 10;
        }
        
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            
            .controls-panel {
                order: 2;
            }
            
            .map-container {
                order: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÅ AutoFlight</h1>
            <p class="subtitle">Automated Flight Path Planner for DJI Mini 4K</p>
        </header>
        
        <div class="app-container">
            <div class="controls-panel">
                <div class="section">
                    <div class="section-title">Mission Settings</div>
                    <div class="form-group">
                        <label for="missionName">Mission Name</label>
                        <input type="text" id="missionName" placeholder="My Flight Mission" value="My Flight Mission">
                    </div>
                    <div class="form-group">
                        <label for="centerLat">Center Latitude</label>
                        <input type="number" id="centerLat" step="0.000001" value="30.267200" placeholder="30.267200">
                    </div>
                    <div class="form-group">
                        <label for="centerLng">Center Longitude</label>
                        <input type="number" id="centerLng" step="0.000001" value="-97.743100" placeholder="-97.743100">
                    </div>
                    <div class="form-group">
                        <label for="altitude">Altitude (meters)</label>
                        <input type="number" id="altitude" min="30" max="120" value="50" step="5">
                        <small style="color: #888; font-size: 0.8em;">DJI Mini 4K: 30-120m recommended</small>
                    </div>
                    <div class="form-group">
                        <label for="speed">Speed (m/s)</label>
                        <input type="number" id="speed" min="1" max="16" value="5" step="0.5">
                        <small style="color: #888; font-size: 0.8em;">DJI Mini 4K max: 16 m/s</small>
                    </div>
                    <div class="form-group">
                        <label for="gimbalPitch">Gimbal Pitch (degrees)</label>
                        <input type="number" id="gimbalPitch" min="-90" max="0" value="-45" step="5">
                    </div>
                    <div class="form-group">
                        <label for="photoInterval">Photo Interval (seconds)</label>
                        <input type="number" id="photoInterval" min="2" max="60" value="5" step="1">
                    </div>
                    <button class="button button-secondary" onclick="recenterMap()">Update Map Center</button>
                </div>
                
                <div class="section">
                    <div class="section-title">Waypoints</div>
                    <p style="color: #888; font-size: 0.85em; margin-bottom: 10px;">
                        Click on the map to add waypoints
                    </p>
                    <div class="waypoint-list" id="waypointList">
                        <p style="color: #666; font-size: 0.85em; text-align: center;">No waypoints added yet</p>
                    </div>
                    <button class="button button-secondary" onclick="clearWaypoints()">Clear All Waypoints</button>
                </div>
                
                <div class="section">
                    <div class="section-title">Mission Info</div>
                    <div class="info-box">
                        <div class="info-item">
                            <span class="info-label">Total Waypoints:</span>
                            <span class="info-value" id="totalWaypoints">0</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Est. Distance:</span>
                            <span class="info-value" id="totalDistance">0 m</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Est. Duration:</span>
                            <span class="info-value" id="totalDuration">0:00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Est. Photos:</span>
                            <span class="info-value" id="totalPhotos">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">Export</div>
                    <button class="button" onclick="exportKMZ()" id="exportBtn" disabled>
                        üì• Export KMZ File
                    </button>
                    <p style="color: #888; font-size: 0.85em; margin-top: 10px; text-align: center;">
                        Add at least 2 waypoints to export
                    </p>
                </div>
            </div>
            
            <div class="map-container">
                <div class="map-info">
                    Click on the canvas to add waypoints<br>
                    Scale: ~100m per 100px at center
                </div>
                <canvas id="canvas-map"></canvas>
            </div>
        </div>
        
        <div class="instructions">
            <h3>How to Use AutoFlight</h3>
            <ol>
                <li><strong>Set Mission Parameters:</strong> Configure altitude, speed, gimbal angle, and photo interval for your DJI Mini 4K. Set the center coordinates for your mission area.</li>
                <li><strong>Add Waypoints:</strong> Click on the canvas to add waypoints. The drone will fly through these points in order.</li>
                <li><strong>Review Mission:</strong> Check the estimated distance, duration, and number of photos in the Mission Info panel.</li>
                <li><strong>Export KMZ:</strong> Click "Export KMZ File" to download the flight plan. This file contains all waypoint data and can be imported into GIS software or DJI flight planning apps.</li>
                <li><strong>Import to DJI App:</strong> Use the KMZ file with compatible DJI flight planning software for your Mini 4K. The KML data includes all flight parameters.</li>
            </ol>
        </div>
    </div>
    
    <script>
        // Canvas and map state
        const canvas = document.getElementById('canvas-map');
        const ctx = canvas.getContext('2d');
        let waypoints = [];
        
        // Map configuration (meters per pixel at center - approximate)
        let metersPerPixel = 1.0; // Roughly 1 meter per pixel
        let centerLat = 30.267200;
        let centerLng = -97.743100;
        
        function initCanvas() {
            // Set canvas size
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = 600;
            
            centerLat = parseFloat(document.getElementById('centerLat').value) || 30.267200;
            centerLng = parseFloat(document.getElementById('centerLng').value) || -97.743100;
            
            drawMap();
        }
        
        function drawMap() {
            // Clear canvas
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            ctx.strokeStyle = '#222';
            ctx.lineWidth = 1;
            
            // Vertical lines
            for (let x = 0; x < canvas.width; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // Horizontal lines
            for (let y = 0; y < canvas.height; y += 50) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // Draw center point
            ctx.fillStyle = '#ff0033';
            ctx.beginPath();
            ctx.arc(canvas.width / 2, canvas.height / 2, 5, 0, 2 * Math.PI);
            ctx.fill();
            
            ctx.fillStyle = '#ff0033';
            ctx.font = '12px Arial';
            ctx.fillText('Center', canvas.width / 2 + 10, canvas.height / 2);
            
            // Draw waypoints and path
            if (waypoints.length > 0) {
                // Draw path lines
                if (waypoints.length > 1) {
                    ctx.strokeStyle = '#ff0033';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([5, 5]);
                    
                    ctx.beginPath();
                    ctx.moveTo(waypoints[0].x, waypoints[0].y);
                    for (let i = 1; i < waypoints.length; i++) {
                        ctx.lineTo(waypoints[i].x, waypoints[i].y);
                    }
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
                
                // Draw waypoints
                waypoints.forEach((wp, index) => {
                    // Draw circle
                    ctx.fillStyle = '#ff0033';
                    ctx.beginPath();
                    ctx.arc(wp.x, wp.y, 15, 0, 2 * Math.PI);
                    ctx.fill();
                    
                    // Draw border
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // Draw number
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(index + 1, wp.x, wp.y);
                });
            }
        }
        
        function pixelToLatLng(x, y) {
            const dx = (x - canvas.width / 2) * metersPerPixel;
            const dy = (canvas.height / 2 - y) * metersPerPixel;
            
            // Approximate conversion (more accurate for small areas)
            const lat = centerLat + (dy / 111320);
            const lng = centerLng + (dx / (111320 * Math.cos(centerLat * Math.PI / 180)));
            
            return { lat, lng };
        }
        
        canvas.addEventListener('click', function(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const coords = pixelToLatLng(x, y);
            const altitude = parseFloat(document.getElementById('altitude').value);
            
            waypoints.push({
                x: x,
                y: y,
                lat: coords.lat,
                lng: coords.lng,
                altitude: altitude
            });
            
            drawMap();
            updateWaypointList();
            updateMissionInfo();
        });
        
        function updateWaypointList() {
            const list = document.getElementById('waypointList');
            
            if (waypoints.length === 0) {
                list.innerHTML = '<p style="color: #666; font-size: 0.85em; text-align: center;">No waypoints added yet</p>';
            } else {
                list.innerHTML = waypoints.map((wp, index) => `
                    <div class="waypoint-item">
                        <span class="waypoint-coords">
                            <strong>WP${index + 1}:</strong> ${wp.lat.toFixed(6)}, ${wp.lng.toFixed(6)}
                        </span>
                        <button class="waypoint-delete" onclick="deleteWaypoint(${index})">√ó</button>
                    </div>
                `).join('');
            }
            
            document.getElementById('exportBtn').disabled = waypoints.length < 2;
        }
        
        function deleteWaypoint(index) {
            waypoints.splice(index, 1);
            drawMap();
            updateWaypointList();
            updateMissionInfo();
        }
        
        function clearWaypoints() {
            if (waypoints.length === 0) return;
            
            if (confirm('Are you sure you want to clear all waypoints?')) {
                waypoints = [];
                drawMap();
                updateWaypointList();
                updateMissionInfo();
            }
        }
        
        function recenterMap() {
            initCanvas();
        }
        
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function updateMissionInfo() {
            document.getElementById('totalWaypoints').textContent = waypoints.length;
            
            if (waypoints.length < 2) {
                document.getElementById('totalDistance').textContent = '0 m';
                document.getElementById('totalDuration').textContent = '0:00';
                document.getElementById('totalPhotos').textContent = '0';
                return;
            }
            
            let totalDistance = 0;
            for (let i = 0; i < waypoints.length - 1; i++) {
                totalDistance += calculateDistance(
                    waypoints[i].lat, waypoints[i].lng,
                    waypoints[i + 1].lat, waypoints[i + 1].lng
                );
            }
            
            if (totalDistance > 1000) {
                document.getElementById('totalDistance').textContent = (totalDistance / 1000).toFixed(2) + ' km';
            } else {
                document.getElementById('totalDistance').textContent = totalDistance.toFixed(0) + ' m';
            }
            
            const speed = parseFloat(document.getElementById('speed').value);
            const durationSeconds = totalDistance / speed;
            const minutes = Math.floor(durationSeconds / 60);
            const seconds = Math.floor(durationSeconds % 60);
            document.getElementById('totalDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            const photoInterval = parseFloat(document.getElementById('photoInterval').value);
            const estimatedPhotos = Math.floor(durationSeconds / photoInterval);
            document.getElementById('totalPhotos').textContent = estimatedPhotos;
        }
        
        document.getElementById('speed').addEventListener('change', updateMissionInfo);
        document.getElementById('photoInterval').addEventListener('change', updateMissionInfo);
        
        function exportKMZ() {
            if (waypoints.length < 2) {
                alert('Please add at least 2 waypoints to export.');
                return;
            }
            
            const missionName = document.getElementById('missionName').value || 'My Flight Mission';
            const altitude = parseFloat(document.getElementById('altitude').value);
            const speed = parseFloat(document.getElementById('speed').value);
            const gimbalPitch = parseFloat(document.getElementById('gimbalPitch').value);
            const photoInterval = parseFloat(document.getElementById('photoInterval').value);
            
            const kml = generateKML(missionName, altitude, speed, gimbalPitch, photoInterval);
            
            // For KMZ, we would normally zip it, but we'll export as KML directly
            const blob = new Blob([kml], { type: 'application/vnd.google-earth.kml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${missionName.replace(/[^a-z0-9]/gi, '_')}.kml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('KML file downloaded successfully! You can convert this to KMZ by zipping it, or import it directly into Google Earth or DJI flight planning apps.');
        }
        
        function generateKML(missionName, altitude, speed, gimbalPitch, photoInterval) {
            let placemarks = '';
            
            waypoints.forEach((wp, index) => {
                placemarks += `
        <Placemark>
            <name>Waypoint ${index + 1}</name>
            <description>
                Altitude: ${altitude}m
                Speed: ${speed}m/s
                Gimbal: ${gimbalPitch}¬∞
                Photo Interval: ${photoInterval}s
            </description>
            <ExtendedData>
                <Data name="altitude">
                    <value>${altitude}</value>
                </Data>
                <Data name="speed">
                    <value>${speed}</value>
                </Data>
                <Data name="gimbalPitch">
                    <value>${gimbalPitch}</value>
                </Data>
                <Data name="photoInterval">
                    <value>${photoInterval}</value>
                </Data>
                <Data name="waypointIndex">
                    <value>${index}</value>
                </Data>
            </ExtendedData>
            <Point>
                <coordinates>${wp.lng},${wp.lat},${altitude}</coordinates>
            </Point>
        </Placemark>`;
            });
            
            const coordinates = waypoints.map(wp => `${wp.lng},${wp.lat},${altitude}`).join('\n                ');
            
            const kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
        <name>${missionName}</name>
        <description>
            DJI Mini 4K Automated Flight Path
            Generated by AutoFlight - Second Sight Solutions
            
            Mission Parameters:
            - Altitude: ${altitude}m
            - Speed: ${speed}m/s
            - Gimbal Pitch: ${gimbalPitch}¬∞
            - Photo Interval: ${photoInterval}s
            - Total Waypoints: ${waypoints.length}
        </description>
        
        <Style id="waypointStyle">
            <IconStyle>
                <color>ff0033ff</color>
                <scale>1.2</scale>
                <Icon>
                    <href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href>
                </Icon>
            </IconStyle>
        </Style>
        
        <Style id="pathStyle">
            <LineStyle>
                <color>ff0033ff</color>
                <width>3</width>
            </LineStyle>
        </Style>
        
        <Folder>
            <name>Waypoints</name>
            ${placemarks}
        </Folder>
        
        <Placemark>
            <name>Flight Path</name>
            <styleUrl>#pathStyle</styleUrl>
            <LineString>
                <tessellate>1</tessellate>
                <altitudeMode>absolute</altitudeMode>
                <coordinates>
                ${coordinates}
                </coordinates>
            </LineString>
        </Placemark>
    </Document>
</kml>`;
            
            return kml;
        }
        
        // Initialize on load
        window.addEventListener('load', initCanvas);
        window.addEventListener('resize', initCanvas);
    </script>
</body>
</html>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 30px 20px;
            background: rgba(255, 0, 51, 0.1);
            border-bottom: 2px solid #ff0033;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5em;
            color: #ff0033;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255, 0, 51, 0.5);
        }
        
        .subtitle {
            font-size: 1.1em;
            color: #cccccc;
        }
        
        .app-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .controls-panel {
            background: rgba(26, 26, 46, 0.8);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            height: fit-content;
        }
        
        .section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #333;
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            font-size: 1.2em;
            color: #ff0033;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #cccccc;
            font-size: 0.9em;
        }
        
        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #444;
            border-radius: 5px;
            color: #ffffff;
            font-size: 0.95em;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #ff0033;
        }
        
        .map-container {
            background: #1a1a2e;
            border: 1px solid #333;
            border-radius: 10px;
            overflow: hidden;
            height: 600px;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .button {
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, #ff0033 0%, #cc0029 100%);
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .button:hover {
            background: linear-gradient(135deg, #cc0029 0%, #990020 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 0, 51, 0.4);
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .button-secondary {
            background: linear-gradient(135deg, #333 0%, #222 100%);
        }
        
        .button-secondary:hover {
            background: linear-gradient(135deg, #444 0%, #333 100%);
        }
        
        .waypoint-list {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
        }
        
        .waypoint-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 5px;
            border-radius: 3px;
            font-size: 0.85em;
        }
        
        .waypoint-item:hover {
            background: rgba(255, 0, 51, 0.1);
        }
        
        .waypoint-coords {
            flex: 1;
        }
        
        .waypoint-delete {
            background: #cc0029;
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        
        .waypoint-delete:hover {
            background: #990020;
        }
        
        .info-box {
            background: rgba(255, 0, 51, 0.1);
            border: 1px solid #ff0033;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .info-label {
            color: #cccccc;
        }
        
        .info-value {
            color: #ff0033;
            font-weight: bold;
        }
        
        .instructions {
            background: rgba(26, 26, 46, 0.8);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .instructions h3 {
            color: #ff0033;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            margin-left: 20px;
            line-height: 1.8;
        }
        
        .instructions li {
            margin-bottom: 10px;
            color: #cccccc;
        }
        
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            
            .controls-panel {
                order: 2;
            }
            
            .map-container {
                order: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÅ AutoFlight</h1>
            <p class="subtitle">Automated Flight Path Planner for DJI Mini 4K</p>
        </header>
        
        <div class="app-container">
            <div class="controls-panel">
                <div class="section">
                    <div class="section-title">Mission Settings</div>
                    <div class="form-group">
                        <label for="missionName">Mission Name</label>
                        <input type="text" id="missionName" placeholder="My Flight Mission" value="My Flight Mission">
                    </div>
                    <div class="form-group">
                        <label for="altitude">Altitude (meters)</label>
                        <input type="number" id="altitude" min="30" max="120" value="50" step="5">
                        <small style="color: #888; font-size: 0.8em;">DJI Mini 4K: 30-120m recommended</small>
                    </div>
                    <div class="form-group">
                        <label for="speed">Speed (m/s)</label>
                        <input type="number" id="speed" min="1" max="16" value="5" step="0.5">
                        <small style="color: #888; font-size: 0.8em;">DJI Mini 4K max: 16 m/s</small>
                    </div>
                    <div class="form-group">
                        <label for="gimbalPitch">Gimbal Pitch (degrees)</label>
                        <input type="number" id="gimbalPitch" min="-90" max="0" value="-45" step="5">
                    </div>
                    <div class="form-group">
                        <label for="photoInterval">Photo Interval (seconds)</label>
                        <input type="number" id="photoInterval" min="2" max="60" value="5" step="1">
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">Waypoints</div>
                    <p style="color: #888; font-size: 0.85em; margin-bottom: 10px;">
                        Click on the map to add waypoints
                    </p>
                    <div class="waypoint-list" id="waypointList">
                        <p style="color: #666; font-size: 0.85em; text-align: center;">No waypoints added yet</p>
                    </div>
                    <button class="button button-secondary" onclick="clearWaypoints()">Clear All Waypoints</button>
                </div>
                
                <div class="section">
                    <div class="section-title">Mission Info</div>
                    <div class="info-box">
                        <div class="info-item">
                            <span class="info-label">Total Waypoints:</span>
                            <span class="info-value" id="totalWaypoints">0</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Est. Distance:</span>
                            <span class="info-value" id="totalDistance">0 m</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Est. Duration:</span>
                            <span class="info-value" id="totalDuration">0:00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Est. Photos:</span>
                            <span class="info-value" id="totalPhotos">0</span>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">Export</div>
                    <button class="button" onclick="exportKMZ()" id="exportBtn" disabled>
                        üì• Export KMZ File
                    </button>
                    <p style="color: #888; font-size: 0.85em; margin-top: 10px; text-align: center;">
                        Add at least 2 waypoints to export
                    </p>
                </div>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
        
        <div class="instructions">
            <h3>How to Use AutoFlight</h3>
            <ol>
                <li><strong>Set Mission Parameters:</strong> Configure altitude, speed, gimbal angle, and photo interval for your DJI Mini 4K.</li>
                <li><strong>Add Waypoints:</strong> Click on the map to add waypoints. The drone will fly through these points in order.</li>
                <li><strong>Review Mission:</strong> Check the estimated distance, duration, and number of photos in the Mission Info panel.</li>
                <li><strong>Export KMZ:</strong> Click "Export KMZ File" to download the flight plan. This file can be imported into DJI flight planning apps.</li>
                <li><strong>Import to DJI App:</strong> Use the KMZ file with compatible DJI flight planning software for your Mini 4K.</li>
            </ol>
        </div>
    </div>
    
    <script>
        // Initialize map centered on Austin, Texas (can be changed by user)
        const map = L.map('map').setView([30.2672, -97.7431], 13);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        // Waypoints array
        let waypoints = [];
        let markers = [];
        let pathLine = null;
        
        // Add click handler to map
        map.on('click', function(e) {
            addWaypoint(e.latlng.lat, e.latlng.lng);
        });
        
        function addWaypoint(lat, lng) {
            const waypointNum = waypoints.length + 1;
            
            // Add to waypoints array
            waypoints.push({
                lat: lat,
                lng: lng,
                altitude: parseFloat(document.getElementById('altitude').value)
            });
            
            // Create marker
            const marker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #ff0033; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white;">${waypointNum}</div>`,
                    iconSize: [30, 30]
                })
            }).addTo(map);
            
            markers.push(marker);
            
            // Update path line
            updatePathLine();
            
            // Update UI
            updateWaypointList();
            updateMissionInfo();
        }
        
        function updatePathLine() {
            // Remove old line
            if (pathLine) {
                map.removeLayer(pathLine);
            }
            
            // Draw new line
            if (waypoints.length > 1) {
                const latLngs = waypoints.map(wp => [wp.lat, wp.lng]);
                pathLine = L.polyline(latLngs, {
                    color: '#ff0033',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(map);
            }
        }
        
        function updateWaypointList() {
            const list = document.getElementById('waypointList');
            
            if (waypoints.length === 0) {
                list.innerHTML = '<p style="color: #666; font-size: 0.85em; text-align: center;">No waypoints added yet</p>';
            } else {
                list.innerHTML = waypoints.map((wp, index) => `
                    <div class="waypoint-item">
                        <span class="waypoint-coords">
                            <strong>WP${index + 1}:</strong> ${wp.lat.toFixed(6)}, ${wp.lng.toFixed(6)}
                        </span>
                        <button class="waypoint-delete" onclick="deleteWaypoint(${index})">√ó</button>
                    </div>
                `).join('');
            }
            
            // Enable/disable export button
            document.getElementById('exportBtn').disabled = waypoints.length < 2;
        }
        
        function deleteWaypoint(index) {
            // Remove from arrays
            waypoints.splice(index, 1);
            map.removeLayer(markers[index]);
            markers.splice(index, 1);
            
            // Re-number remaining markers
            markers.forEach((marker, i) => {
                marker.setIcon(L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #ff0033; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white;">${i + 1}</div>`,
                    iconSize: [30, 30]
                }));
            });
            
            updatePathLine();
            updateWaypointList();
            updateMissionInfo();
        }
        
        function clearWaypoints() {
            if (waypoints.length === 0) return;
            
            if (confirm('Are you sure you want to clear all waypoints?')) {
                // Remove all markers
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
                waypoints = [];
                
                // Remove path line
                if (pathLine) {
                    map.removeLayer(pathLine);
                    pathLine = null;
                }
                
                updateWaypointList();
                updateMissionInfo();
            }
        }
        
        function calculateDistance(lat1, lng1, lat2, lng2) {
            // Haversine formula
            const R = 6371000; // Earth's radius in meters
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function updateMissionInfo() {
            document.getElementById('totalWaypoints').textContent = waypoints.length;
            
            if (waypoints.length < 2) {
                document.getElementById('totalDistance').textContent = '0 m';
                document.getElementById('totalDuration').textContent = '0:00';
                document.getElementById('totalPhotos').textContent = '0';
                return;
            }
            
            // Calculate total distance
            let totalDistance = 0;
            for (let i = 0; i < waypoints.length - 1; i++) {
                totalDistance += calculateDistance(
                    waypoints[i].lat, waypoints[i].lng,
                    waypoints[i + 1].lat, waypoints[i + 1].lng
                );
            }
            
            // Update distance display
            if (totalDistance > 1000) {
                document.getElementById('totalDistance').textContent = (totalDistance / 1000).toFixed(2) + ' km';
            } else {
                document.getElementById('totalDistance').textContent = totalDistance.toFixed(0) + ' m';
            }
            
            // Calculate duration
            const speed = parseFloat(document.getElementById('speed').value);
            const durationSeconds = totalDistance / speed;
            const minutes = Math.floor(durationSeconds / 60);
            const seconds = Math.floor(durationSeconds % 60);
            document.getElementById('totalDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Calculate estimated photos
            const photoInterval = parseFloat(document.getElementById('photoInterval').value);
            const estimatedPhotos = Math.floor(durationSeconds / photoInterval);
            document.getElementById('totalPhotos').textContent = estimatedPhotos;
        }
        
        // Update mission info when settings change
        document.getElementById('speed').addEventListener('change', updateMissionInfo);
        document.getElementById('photoInterval').addEventListener('change', updateMissionInfo);
        
        async function exportKMZ() {
            if (waypoints.length < 2) {
                alert('Please add at least 2 waypoints to export.');
                return;
            }
            
            const missionName = document.getElementById('missionName').value || 'My Flight Mission';
            const altitude = parseFloat(document.getElementById('altitude').value);
            const speed = parseFloat(document.getElementById('speed').value);
            const gimbalPitch = parseFloat(document.getElementById('gimbalPitch').value);
            const photoInterval = parseFloat(document.getElementById('photoInterval').value);
            
            // Generate KML content
            const kml = generateKML(missionName, altitude, speed, gimbalPitch, photoInterval);
            
            // Create KMZ (zipped KML)
            const zip = new JSZip();
            zip.file('doc.kml', kml);
            
            // Generate and download
            const blob = await zip.generateAsync({type: 'blob'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${missionName.replace(/[^a-z0-9]/gi, '_')}.kmz`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('KMZ file downloaded successfully! Import it into your DJI flight planning app.');
        }
        
        function generateKML(missionName, altitude, speed, gimbalPitch, photoInterval) {
            let placemarks = '';
            
            waypoints.forEach((wp, index) => {
                placemarks += `
                <Placemark>
                    <name>Waypoint ${index + 1}</name>
                    <description>
                        Altitude: ${altitude}m
                        Speed: ${speed}m/s
                        Gimbal: ${gimbalPitch}¬∞
                        Photo Interval: ${photoInterval}s
                    </description>
                    <ExtendedData>
                        <Data name="altitude">
                            <value>${altitude}</value>
                        </Data>
                        <Data name="speed">
                            <value>${speed}</value>
                        </Data>
                        <Data name="gimbalPitch">
                            <value>${gimbalPitch}</value>
                        </Data>
                        <Data name="photoInterval">
                            <value>${photoInterval}</value>
                        </Data>
                        <Data name="waypointIndex">
                            <value>${index}</value>
                        </Data>
                    </ExtendedData>
                    <Point>
                        <coordinates>${wp.lng},${wp.lat},${altitude}</coordinates>
                    </Point>
                </Placemark>`;
            });
            
            // Generate path line
            const coordinates = waypoints.map(wp => `${wp.lng},${wp.lat},${altitude}`).join('\n                        ');
            
            const kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
        <name>${missionName}</name>
        <description>
            DJI Mini 4K Automated Flight Path
            Generated by AutoFlight - Second Sight Solutions
            
            Mission Parameters:
            - Altitude: ${altitude}m
            - Speed: ${speed}m/s
            - Gimbal Pitch: ${gimbalPitch}¬∞
            - Photo Interval: ${photoInterval}s
            - Total Waypoints: ${waypoints.length}
        </description>
        
        <Style id="waypointStyle">
            <IconStyle>
                <color>ff0033ff</color>
                <scale>1.2</scale>
                <Icon>
                    <href>http://maps.google.com/mapfiles/kml/shapes/placemark_circle.png</href>
                </Icon>
            </IconStyle>
        </Style>
        
        <Style id="pathStyle">
            <LineStyle>
                <color>ff0033ff</color>
                <width>3</width>
            </LineStyle>
        </Style>
        
        <Folder>
            <name>Waypoints</name>
            ${placemarks}
        </Folder>
        
        <Placemark>
            <name>Flight Path</name>
            <styleUrl>#pathStyle</styleUrl>
            <LineString>
                <tessellate>1</tessellate>
                <altitudeMode>absolute</altitudeMode>
                <coordinates>
                        ${coordinates}
                </coordinates>
            </LineString>
        </Placemark>
    </Document>
</kml>`;
            
            return kml;
        }
    </script>
</body>
</html>
